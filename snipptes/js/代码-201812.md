# 代码块整理

## 是什么

收集 整理一些代码块，强化记忆

## 异步代码

### 1. async/await

`async/await` 是 `Promise` 的语法糖。

```js
import axios from "axios";
// await 只能使用在 async 函数中，不能用于全局作用域。
async function getData() {
  const results = await axios.get("https://dube.io/service/ping");
  const data = results.data;
  console.log("data", data);
  return data;
}
getData();
```

### 2. 异步控制流-一个请求

```js
import axios from "axios";

let myData = [{ id: 0 }, { id: 1 }, { id: 2 }, { id: 3 }];

async function fetchData(dataSet) {
  for (entry of dataSet) {
    const result = await axios.get(
      `https://ironhackpokeapi.herokuapp.com/pokemon/${entry.id}`
    );
    const newData = result.data;
    updateData(newData);
    console.log(myData);
  }
}
function updateData(newData) {
  myData = myData.map((el) => {
    if (el.id === newData.id) return newData;
    return el;
  });
}
fetchData(myData);
```

### 3. 异步控制流-多个请求

```js
import axios from "axios";

let myData = [{ id: 0 }, { id: 1 }, { id: 2 }, { id: 3 }];
async function fetchData(dataSet) {
  const pokemonPromises = dataSet.map((entry) => {
    return axios.get(
      `https://ironhack-pokeapi.herokuapp.com/pokemon/${entry.id}`
    );
  });
  const results = await Promise.all(pokemonPromises);
  results.forEach((result) => {
    updateData(result.data);
  });
  console.log(myData);
}
function updateData(newData) {
  myData = myData.map((el) => {
    if (el.id === newData.id) return newData;
    return el;
  });
}
fetchData(myData);
```

### 4. 请求多个 url 后 执行操作

```js
// 多条ajax 回调
var url1 = "http://test.jxq.net/php/test/ajax1.php";
var url = "http://test.jxq.net/php/test/ajax.php";
// 处理多个请求的 ajax 回调
var requests = $.when(
  $.ajax({
    url: url1,
    type: "GET",
  }),
  $.ajax({
    url: url,
    type: "GET",
  })
);
requests.then(
  function (arg1, arg2) {
    var items = JSON.parse(arg1[0]);
    var hs = JSON.parse(arg2[0]);
    $("h1").html(hs["apples"]);
    var $ul = "<ul>";
    for (var i = 0; i < items.length; i++) {
      $ul += "<li>" + items[i]["title"] + "</li>";
    }
    $ul += "</ul>";
    $("#info").html($ul);
    //console.log( 'success：' + arg1[0] + arg2[0] );
  },
  function (arg1, arg2) {
    //console.log( 'failure：' + arg1 + arg2  );
  }
);
```

## 文件下载

```html
<div>
  <h3>FileSystem 并发文件下载器 Demo</h3>
  <div>仅在 Chrome 29+ 测试通过！</div>
  <div>
    <a href="http://www.imququ.com/post/a-downloader-with-filesystem-api.html"
      >返回文章</a
    >
  </div>
  <div>
    slot1: <progress id="per0" max="500" value="0"></progress
    ><span id="info0"></span>
  </div>
  <div>
    slot2: <progress id="per1" max="500" value="0"></progress
    ><span id="info1"></span>
  </div>
  <div>
    slot3: <progress id="per2" max="500" value="0"></progress
    ><span id="info2"></span>
  </div>
  <div>
    slot4: <progress id="per3" max="500" value="0"></progress
    ><span id="info3"></span>
  </div>
  <div>
    <input id="submit" type="button" value="开始下载" /><span id="info"></span>
  </div>
</div>
<div download id="dl"></div>
<script src="../libs/when.js"></script>
<script type="text/javascript">
  function CreateFile(fileName) {
    var deferred = when.defer();

    window.webkitRequestFileSystem(
      window.TEMPORARY,
      10 * 1024 * 1024,
      function (fs) {
        var dirName = (+new Date()).toString(36);

        fs.root.getDirectory(dirName, { create: true }, function (dirEntry) {
          var filePath = dirName + "/" + fileName;

          fs.root.getFile(filePath, { create: true }, function (fileEntry) {
            fileEntry.createWriter(function (fileWriter) {
              var ret = {
                fileEntry: fileEntry,
                fileWriter: fileWriter,
              };

              deferred.resolve(ret);
            });
          });
        });
      }
    );

    return deferred.promise;
  }
  function Downloader(id, url, mimeType, range) {
    var deferred = when.defer();

    var startTime, totalSize;

    var xhr = new XMLHttpRequest();
    xhr.open("GET", url, true);

    xhr.onreadystatechange = function () {
      if (this.readyState == 4) {
        if (this.response != null) {
          var ret = {
            size: parseInt(this.response.byteLength),
            blob: new Blob([new Uint8Array(this.response)], { type: mimeType }),
          };

          $("per" + id).value = 500;
          $("info" + id).innerHTML =
            "（完成，平均速度：" +
            (totalSize / (+new Date() - startTime)).toFixed(2) +
            "kb/s）";

          deferred.resolve(ret);
        }
      }
    };

    xhr.onprogress = function (e) {
      var loaded = e.loaded,
        total = e.total;

      totalSize = e.total;

      $("per" + id).value = parseInt((loaded / total) * 500);
      $("info" + id).innerHTML =
        "（" + [loaded + "b", total + "b"].join(" / ") + "）";
    };

    xhr.setRequestHeader("Range", "bytes=" + range);
    xhr.responseType = "arraybuffer";

    xhr.send();

    startTime = +new Date();

    return deferred.promise;
  }
  function UriAnalyser(url) {
    //参数合法性检查，忽略..
    //异常情况，忽略..

    var deferred = when.defer();

    var xhr = new XMLHttpRequest();
    xhr.open("HEAD", url, true);

    xhr.onreadystatechange = function () {
      if (2 == this.readyState) {
        var ret = {
          mimeType: xhr.getResponseHeader("Content-Type") || "text/plain",
          size: parseInt(xhr.getResponseHeader("Content-Length")) || -1,
        };

        deferred.resolve(ret);
      }
    };
    xhr.send();

    return deferred.promise;
  }
</script>
<script>
  var $ = function (s) {
    return document.getElementById(s);
  };

  var name = "file.zip",
    url = "http://127.0.0.1:3000/libs/file.zip";
  // url = 'https://qgy18.com/download/file.zip';

  function download(urlInfo) {
    when(CreateFile(name)).then(function (fileInfo) {
      $("info").innerHTML = "（总大小：" + urlInfo.size + "b）";

      var downloaders = [],
        max = 4,
        averageSize = parseInt(urlInfo.size / max);

      for (var i = 0; i < max; i++) {
        var range;

        if (i == max - 1) {
          range = [i * averageSize, urlInfo.size];
        } else {
          range = [i * averageSize, (i + 1) * averageSize - 1];
        }

        var downloader = Downloader(i, url, urlInfo.mimeType, range.join("-"));
        downloaders.push(downloader);
      }

      when
        .all(downloaders)
        .then(function (dlInfos) {
          var totalSize = 0,
            current = 0;

          function write() {
            var dlInfo = dlInfos[current];
            fileInfo.fileWriter.write(dlInfo.blob);
            totalSize += dlInfo.size;
          }

          fileInfo.fileWriter.onwriteend = function () {
            current++;
            if (current < max) {
              write();
            } else {
              if (urlInfo.size === totalSize) {
                var link = document.getElementById("dl");
                link.href = fileInfo.fileEntry.toURL();
                link.click();

                $("submit").value = "下载完成";
              } else {
                console.log(urlInfo.size, totalSize);
                alert("下载失败：大小不匹配！");
              }
            }
          };

          write();
        })
        .otherwise(function (e) {
          console.log(e);
        });
    });
  }

  $("submit").addEventListener("click", function () {
    $("submit").disabled = true;
    when(UriAnalyser(url)).then(download);
  });
</script>
```
